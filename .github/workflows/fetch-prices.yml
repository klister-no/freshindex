name: Fetch EU Agridata Weekly

on:
  schedule:
    - cron: '0 8 * * 5'  # Fredag kl 08:00 UTC
  workflow_dispatch:       # Manuell kj√∏ring fra GitHub

jobs:
  fetch-prices:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch EU Agridata prices
        run: |
          python3 << 'PYEOF'
          import urllib.request
          import urllib.parse
          import json
          import datetime
          import time

          PRODUCTS = {
            "avocado":     "Avocados",
            "strawberry":  "Strawberries",
            "raspberry":   "Raspberries",
            "banana":      "Bananas",
            "tomato":      "Tomatoes",
            "apple":       "Apples",
            "orange":      "Oranges",
            "pepper":      "Sweet peppers",
            "cucumber":    "Cucumbers",
            "lettuce":     "Lettuces",
            "grape":       "Table grapes",
            "cauliflower": "Cauliflowers",
            "carrot":      "Carrots",
            "blueberry":   "Blueberries",
            "cherry":      "Cherries",
            "pear":        "Pears",
            "broccoli":    "Broccoli",
            "peach":       "Peaches",
          }

          STAGE = "Ex-packaging station price"

          end = datetime.date.today()
          start = end - datetime.timedelta(weeks=52)

          def fmt(d):
            return d.strftime("%d/%m/%Y")

          results = {}
          errors = []

          for key, product in PRODUCTS.items():
            try:
              params = urllib.parse.urlencode({
                "products": product,
                "productStages": STAGE,
                "beginDate": fmt(start),
                "endDate": fmt(end)
              })
              url = f"https://agridata.ec.europa.eu/api/fruitAndVegetable/pricesSupplyChain?{params}"
              print(f"Henter: {url}")

              req = urllib.request.Request(url, headers={
                "Accept": "application/json",
                "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
              })

              with urllib.request.urlopen(req, timeout=20) as resp:
                raw = resp.read()
                data = json.loads(raw)

              if not data or not isinstance(data, list):
                errors.append(f"{key}: ingen data returnert")
                continue

              # Grupper per uke
              by_week = {}
              for row in data:
                wkey = f"{row['year']}-{str(row['period']).zfill(2)}"
                if wkey not in by_week:
                  by_week[wkey] = {"prices": [], "year": row["year"], "period": row["period"]}
                try:
                  p = float(str(row.get("price", 0)).replace(",", ".").replace("‚Ç¨", "").strip())
                  if p > 0:
                    by_week[wkey]["prices"].append(p)
                except:
                  pass

              sorted_weeks = sorted(by_week.items())
              prices = []
              labels = []
              for wk, v in sorted_weeks:
                if v["prices"]:
                  avg = sum(v["prices"]) / len(v["prices"])
                  prices.append(round(avg, 2))
                  labels.append(f"Uke {v['period']} {v['year']}")

              if len(prices) >= 2:
                latest = prices[-1]
                prev = prices[-2]
                week_change = round(((latest - prev) / prev) * 100, 1)
                results[key] = {
                  "prices": prices,
                  "labels": labels,
                  "latest": latest,
                  "weekChange": week_change,
                  "source": "live"
                }
                print(f"  ‚úÖ {key}: ‚Ç¨{latest:.2f}/100kg ({week_change:+.1f}%)")
              else:
                errors.append(f"{key}: for f√• datapunkter ({len(prices)})")

              time.sleep(1)

            except Exception as e:
              errors.append(f"{key}: {str(e)}")
              print(f"  ‚ùå {key}: {e}")

          output = {
            "fetched": datetime.datetime.utcnow().isoformat() + "Z",
            "week": datetime.date.today().isocalendar()[1],
            "year": datetime.date.today().year,
            "stage": STAGE,
            "products": results,
            "errors": errors,
            "liveCount": len(results),
            "totalCount": len(PRODUCTS)
          }

          with open("prices.json", "w") as f:
            json.dump(output, f, indent=2, ensure_ascii=False)

          print(f"\nFerdig: {len(results)}/{len(PRODUCTS)} produkter hentet")
          if errors:
            print(f"Feil: {errors}")
          PYEOF

      - name: Commit and push prices.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add prices.json
          git diff --staged --quiet || git commit -m "üìä Prisoppdatering uke $(date +%V) $(date +%Y)"
          git push
