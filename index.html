<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BAMA FreshIndex ‚Äî Markedsprismonitor</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root {
  --bg:#090d18;--bg2:#0d1220;--bg3:#131929;
  --panel:#182030;--panel2:#1c2638;
  --border:rgba(255,255,255,0.07);--border2:rgba(255,255,255,0.13);
  --text:#e8edf5;--text2:#8a95aa;--text3:#4e5a70;
  --up:#4ade80;--down:#f87171;--neutral:#fbbf24;--accent:#3b82f6;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;min-height:100vh;}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(59,130,246,0.025) 1px,transparent 1px),linear-gradient(90deg,rgba(59,130,246,0.025) 1px,transparent 1px);background-size:44px 44px;pointer-events:none;z-index:0;}
.app{position:relative;z-index:1;display:flex;flex-direction:column;min-height:100vh;}

/* HEADER */
header{display:flex;align-items:center;justify-content:space-between;padding:12px 24px;border-bottom:1px solid var(--border);background:rgba(9,13,24,0.95);backdrop-filter:blur(20px);position:sticky;top:0;z-index:100;gap:12px;flex-wrap:wrap;}
.logo{display:flex;align-items:center;gap:10px;}
.logo-icon{width:34px;height:34px;background:linear-gradient(135deg,#4ade80,#3b82f6);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0;}
.logo-text{font-family:'DM Serif Display',serif;font-size:20px;letter-spacing:-0.5px;}
.logo-sub{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;letter-spacing:1.2px;text-transform:uppercase;}
.header-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.live-badge{display:flex;align-items:center;gap:6px;background:rgba(74,222,128,0.1);border:1px solid rgba(74,222,128,0.25);border-radius:20px;padding:4px 11px;font-size:10px;color:var(--up);font-family:'DM Mono',monospace;}
.live-dot{width:6px;height:6px;background:var(--up);border-radius:50%;animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(.8)}}
.data-status{font-size:10px;font-family:'DM Mono',monospace;padding:3px 9px;border-radius:6px;border:1px solid var(--border2);}
.status-live{background:rgba(74,222,128,.1);color:var(--up);border-color:rgba(74,222,128,.3);}
.status-loading{background:rgba(251,191,36,.1);color:var(--neutral);border-color:rgba(251,191,36,.3);}
.status-fallback{background:rgba(248,113,113,.1);color:var(--down);border-color:rgba(248,113,113,.3);}
.header-tag{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;}

/* TABS */
.tabs-bar{display:flex;gap:2px;padding:0 24px;border-bottom:1px solid var(--border);background:var(--bg2);}
.tab-btn{padding:10px 18px;font-size:11px;font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);background:transparent;border:none;border-bottom:2px solid transparent;cursor:pointer;transition:all .15s;margin-bottom:-1px;}
.tab-btn:hover{color:var(--text2);}
.tab-btn.active{color:var(--text);border-bottom-color:var(--accent);}

/* MAIN LAYOUT */
.main{display:grid;grid-template-columns:220px 1fr;flex:1;}
.sidebar{border-right:1px solid var(--border);background:var(--bg2);overflow-y:auto;max-height:calc(100vh - 100px);position:sticky;top:100px;}
.sidebar-inner{padding:12px 8px 24px;}
.cat-label{font-size:9px;font-family:'DM Mono',monospace;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);padding:0 8px;margin:12px 0 4px;display:flex;align-items:center;gap:8px;}
.cat-label::after{content:'';flex:1;height:1px;background:var(--border);}
.product-btn{width:100%;display:flex;align-items:center;gap:8px;padding:7px 8px;border-radius:8px;border:1px solid transparent;background:transparent;cursor:pointer;transition:all .15s;margin-bottom:1px;position:relative;overflow:hidden;text-align:left;}
.product-btn:hover{background:var(--panel);border-color:var(--border);}
.product-btn.active{background:var(--panel2);border-color:var(--border2);}
.color-stripe{position:absolute;left:0;top:0;bottom:0;width:3px;border-radius:3px 0 0 3px;}
.product-emoji{font-size:16px;flex-shrink:0;}
.product-info{flex:1;min-width:0;}
.product-name{font-size:11px;font-weight:500;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.product-sub{font-size:9px;color:var(--text3);font-family:'DM Mono',monospace;}
.product-sub-live{font-size:9px;font-family:'DM Mono',monospace;color:#4ade80;}
.product-sub-csv{font-size:9px;font-family:'DM Mono',monospace;color:#60a5fa;}
.product-price-col{text-align:right;flex-shrink:0;}
.product-price{font-size:11px;font-weight:600;font-family:'DM Mono',monospace;}
.product-change{font-size:9px;font-family:'DM Mono',monospace;}
.change-up{color:var(--up);}.change-down{color:var(--down);}.change-neutral{color:var(--neutral);}

/* DRIVER SIDEBAR */
.driver-mini{padding:8px;margin-top:8px;border-top:1px solid var(--border);}
.driver-mini-item{display:flex;justify-content:space-between;align-items:center;padding:5px 6px;border-radius:6px;margin-bottom:1px;cursor:default;}
.driver-mini-item:hover{background:var(--panel);}
.driver-mini-name{font-size:10px;color:var(--text2);}
.driver-mini-val{font-size:10px;font-family:'DM Mono',monospace;font-weight:500;}
.driver-mini-impact{font-size:9px;font-family:'DM Mono',monospace;padding:1px 5px;border-radius:10px;margin-left:4px;}
.impact-neg{background:rgba(248,113,113,.12);color:var(--down);}
.impact-pos{background:rgba(74,222,128,.12);color:var(--up);}
.impact-neu{background:rgba(251,191,36,.1);color:var(--neutral);}

/* CONTENT */
.content{padding:20px 24px;overflow-y:auto;}
.tab-panel{display:none;}.tab-panel.active{display:block;}

/* BANNER */
.api-banner{padding:9px 14px;border-radius:9px;margin-bottom:14px;font-size:11px;font-family:'DM Mono',monospace;display:none;}
.api-banner.show{display:flex;align-items:flex-start;gap:8px;}
.api-banner.warn{background:rgba(251,191,36,.1);border:1px solid rgba(251,191,36,.25);color:var(--neutral);}
.api-banner.ok{background:rgba(74,222,128,.1);border:1px solid rgba(74,222,128,.25);color:var(--up);}

/* INFO BAR */
.info-bar{display:flex;align-items:center;gap:12px;padding:8px 12px;background:rgba(59,130,246,.06);border:1px solid rgba(59,130,246,.15);border-radius:9px;margin-bottom:16px;font-size:10px;color:var(--text2);font-family:'DM Mono',monospace;flex-wrap:wrap;}
.cov-item{display:flex;align-items:center;gap:5px;}
.cov-dot{width:7px;height:7px;border-radius:50%;}

/* FILTER ROW */
.filter-row-wrap{display:flex;gap:16px;margin-bottom:16px;flex-wrap:wrap;align-items:center;}
.filter-group{display:flex;gap:4px;align-items:center;}
.filter-label{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;margin-right:2px;}
.filter-btn{padding:4px 11px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--text3);font-size:10px;font-family:'DM Mono',monospace;cursor:pointer;transition:all .15s;}
.filter-btn:hover{color:var(--text2);border-color:var(--border2);}
.filter-btn.active{background:var(--panel2);border-color:var(--border2);color:var(--text);}

/* KPI */
.section-title{font-family:'DM Serif Display',serif;font-size:16px;margin-bottom:2px;letter-spacing:-.2px;}
.section-sub{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;margin-bottom:12px;}
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(148px,1fr));gap:9px;margin-bottom:20px;}
.kpi-card{background:var(--panel);border:1px solid var(--border);border-radius:11px;padding:12px 13px;cursor:pointer;transition:all .15s;position:relative;overflow:hidden;animation:fadeUp .3s ease both;}
.kpi-card:hover{background:var(--panel2);border-color:var(--border2);transform:translateY(-1px);}
.kpi-card.selected{background:var(--panel2);border-color:var(--border2);}
@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.kpi-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px;}
.kpi-label{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.3px;}
.kpi-emoji{font-size:16px;}
.kpi-price{font-family:'DM Serif Display',serif;font-size:20px;letter-spacing:-.5px;line-height:1;margin-bottom:2px;}
.kpi-unit{font-size:10px;color:var(--text3);font-weight:300;}
.kpi-meta{display:flex;align-items:center;gap:4px;margin-top:4px;flex-wrap:wrap;}
.kpi-badge{font-size:9px;font-family:'DM Mono',monospace;padding:1px 5px;border-radius:20px;font-weight:500;}
.badge-up{background:rgba(74,222,128,.13);color:var(--up);}
.badge-down{background:rgba(248,113,113,.13);color:var(--down);}
.badge-neutral{background:rgba(251,191,36,.12);color:var(--neutral);}
.badge-live{background:rgba(59,130,246,.12);color:#60a5fa;}
.badge-est{background:rgba(255,255,255,.05);color:var(--text3);}
.sparkline-container{height:24px;margin-top:6px;}

/* CHART */
.chart-section{background:var(--panel);border:1px solid var(--border);border-radius:13px;padding:18px;margin-bottom:16px;}
.chart-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px;}
.chart-title{font-family:'DM Serif Display',serif;font-size:16px;letter-spacing:-.3px;margin-bottom:2px;}
.chart-subtitle{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;}
.chart-controls{display:flex;gap:4px;}
.ctrl-btn{padding:3px 10px;border-radius:5px;border:1px solid var(--border);background:transparent;color:var(--text2);font-size:10px;font-family:'DM Mono',monospace;cursor:pointer;transition:all .12s;}
.ctrl-btn:hover{background:var(--panel2);color:var(--text);}
.ctrl-btn.active{background:var(--accent);border-color:var(--accent);color:white;}
.chart-wrap{position:relative;height:240px;}
.forecast-legend{display:flex;align-items:center;gap:12px;margin-top:8px;font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;flex-wrap:wrap;}
.legend-item{display:flex;align-items:center;gap:5px;}

/* BOTTOM PANELS */
.bottom-grid{display:grid;grid-template-columns:1fr 1fr;gap:13px;margin-bottom:16px;}
.panel-card{background:var(--panel);border:1px solid var(--border);border-radius:11px;padding:14px;}
.panel-title{font-size:12px;font-weight:600;margin-bottom:10px;display:flex;align-items:center;gap:6px;}
.panel-icon{width:20px;height:20px;border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:10px;}

/* SEASON */
.season-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:2px;}
.season-month{text-align:center;}
.season-bar{border-radius:3px;margin-bottom:3px;}
.season-now{outline:2px solid rgba(255,255,255,.55);outline-offset:1px;}
.season-lbl{font-size:8px;color:var(--text3);font-family:'DM Mono',monospace;}

/* FORECAST */
.forecast-row{display:flex;gap:5px;margin-bottom:10px;}
.forecast-item{flex:1;background:var(--bg3);border-radius:7px;padding:8px 5px;text-align:center;}
.forecast-period{font-size:9px;color:var(--text3);font-family:'DM Mono',monospace;margin-bottom:3px;text-transform:uppercase;}
.forecast-price{font-size:13px;font-family:'DM Serif Display',serif;margin-bottom:1px;}
.forecast-dir{font-size:9px;font-family:'DM Mono',monospace;}

/* HEATMAP */
.heatmap-grid{display:grid;grid-template-columns:60px repeat(4,1fr);gap:3px;font-size:9px;font-family:'DM Mono',monospace;margin-top:10px;}
.heatmap-cell{padding:5px 3px;border-radius:4px;text-align:center;}
.heatmap-header{color:var(--text3);font-size:8px;text-transform:uppercase;display:flex;align-items:center;justify-content:center;}
.heatmap-row-label{color:var(--text2);display:flex;align-items:center;padding-left:2px;}
.heat-vl{background:rgba(74,222,128,.2);color:#4ade80}
.heat-l{background:rgba(74,222,128,.09);color:#86efac}
.heat-m{background:rgba(251,191,36,.09);color:#fbbf24}
.heat-h{background:rgba(248,113,113,.09);color:#fca5a5}
.heat-vh{background:rgba(248,113,113,.2);color:#f87171}

/* NEWS */
.news-item{display:flex;gap:8px;padding:7px 0;border-bottom:1px solid var(--border);}
.news-item:last-child{border-bottom:none;}
.news-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;margin-top:4px;}
.news-headline{font-size:11px;color:var(--text);margin-bottom:2px;line-height:1.4;}
.news-meta{font-size:9px;color:var(--text3);font-family:'DM Mono',monospace;display:flex;gap:8px;}

/* INFO TABLE */
.info-row{display:flex;justify-content:space-between;margin-bottom:6px;font-size:12px;}
.info-key{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;}

/* COMPARE */
.compare-wrap{height:180px;}

/* SPINNER */
.spinner{display:inline-block;width:11px;height:11px;border:2px solid rgba(255,255,255,.1);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;vertical-align:middle;margin-right:4px;}
@keyframes spin{to{transform:rotate(360deg)}}

/* ============================================================ */
/* MARKEDSDRIVERE TAB */
/* ============================================================ */
.drivers-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;margin-bottom:20px;}
.driver-card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;position:relative;overflow:hidden;}
.driver-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.driver-card.neg::before{background:linear-gradient(90deg,var(--down),transparent);}
.driver-card.pos::before{background:linear-gradient(90deg,var(--up),transparent);}
.driver-card.neu::before{background:linear-gradient(90deg,var(--neutral),transparent);}
.driver-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;}
.driver-name{font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;}
.driver-impact-badge{font-size:9px;font-family:'DM Mono',monospace;padding:2px 7px;border-radius:10px;font-weight:500;}
.driver-value{font-family:'DM Serif Display',serif;font-size:26px;letter-spacing:-1px;line-height:1;margin-bottom:4px;}
.driver-change{font-size:11px;font-family:'DM Mono',monospace;margin-bottom:8px;}
.driver-desc{font-size:11px;color:var(--text3);line-height:1.5;}
.driver-source{font-size:9px;color:var(--text3);font-family:'DM Mono',monospace;margin-top:8px;display:flex;align-items:center;gap:4px;}
.driver-sparkline{height:32px;margin-top:8px;}



.impact-matrix{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:20px;}
.matrix-title{font-family:'DM Serif Display',serif;font-size:15px;margin-bottom:14px;}
.matrix-table{width:100%;border-collapse:collapse;font-size:11px;}
.matrix-table th{font-size:9px;font-family:'DM Mono',monospace;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;padding:5px 8px;text-align:left;border-bottom:1px solid var(--border);}
.matrix-table td{padding:7px 8px;border-bottom:1px solid rgba(255,255,255,.03);}
.matrix-table tr:last-child td{border-bottom:none;}
.matrix-table tr:hover td{background:rgba(255,255,255,.02);}
.impact-pill{padding:2px 8px;border-radius:10px;font-family:'DM Mono',monospace;font-size:9px;white-space:nowrap;}
.pill-high-neg{background:rgba(248,113,113,.2);color:#f87171;}
.pill-med-neg{background:rgba(248,113,113,.1);color:#fca5a5;}
.pill-low{background:rgba(251,191,36,.1);color:#fbbf24;}
.pill-pos{background:rgba(74,222,128,.1);color:#4ade80;}
.pill-none{background:rgba(255,255,255,.04);color:var(--text3);}

.driver-section-title{font-family:'DM Serif Display',serif;font-size:15px;margin-bottom:4px;margin-top:20px;}
.driver-section-sub{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;margin-bottom:12px;}
</style>
</head>
<body>
<div class="app">

<header>
  <div class="logo">
    <div class="logo-icon">üåø</div>
    <div>
      <div class="logo-text">BAMA FreshIndex</div>
      <div class="logo-sub">Markedsprismonitor ¬∑ EU Agridata Live</div>
    </div>
  </div>
  <div class="header-right">
    <div class="live-badge"><div class="live-dot"></div><span id="week-label">LASTER...</span></div>
    <div class="data-status status-loading" id="data-status"><span class="spinner"></span>HENTER DATA</div>
    <div class="header-tag" id="rates-header">EUR/USD ¬∑ ¬∑ ¬∑</div>
  </div>
</header>

<div class="tabs-bar">
  <button class="tab-btn active" onclick="switchTab('priser',this)">üìä Prisoversikt</button>
  <button class="tab-btn" onclick="switchTab('drivere',this)">‚ö° Markedsdrivere</button>
  <button class="tab-btn" onclick="switchTab('pdf',this)">üìä Last opp data</button>
</div>

<div class="main">
<div class="sidebar">
  <div class="sidebar-inner">
    <div id="sidebar-products"></div>
    <div class="driver-mini">
      <div class="cat-label">Live indikatorer</div>
      <div id="sidebar-drivers"></div>
    </div>
  </div>
</div>

<div class="content">

<!-- ==================== TAB: PRISER ==================== -->
<div class="tab-panel active" id="tab-priser">

  <div class="api-banner" id="api-banner"></div>

  <div class="info-bar">
    <span>Prisledd:</span>
    <div class="cov-item"><div class="cov-dot" style="background:#4ade80"></div>Ex-packaging</div>
    <div class="cov-item"><div class="cov-dot" style="background:#fbbf24"></div>Estimert</div>
    <div class="cov-item"><div class="cov-dot" style="background:#818cf8"></div>Farmgate</div>
    <span style="margin-left:auto;font-size:10px">Alle priser ‚Ç¨/kg</span>
  </div>

  <div class="filter-row-wrap">
    <div class="filter-group" id="stage-row">
      <span class="filter-label">PRISNIV√Ö:</span>
      <button class="filter-btn active" onclick="setStage('Ex-packaging station price',this)">Ex-packaging</button>
      <button class="filter-btn" onclick="setStage('Farmgate price',this)">Farmgate</button>
      <button class="filter-btn" onclick="setStage('Retail buying price',this)">Retail</button>
    </div>
    <div class="filter-group" id="cat-row">
      <span class="filter-label">FILTER:</span>
      <button class="filter-btn active" onclick="filterCat('all',this)">Alle</button>
      <button class="filter-btn" onclick="filterCat('frukt',this)">üçé Frukt</button>
      <button class="filter-btn" onclick="filterCat('baer',this)">ü´ê B√¶r</button>
      <button class="filter-btn" onclick="filterCat('gronn',this)">ü•¨ Gr√∏nnsaker</button>
      <button class="filter-btn" onclick="filterCat('sopp',this)">üçÑ Sopp</button>
    </div>
  </div>

  <div class="section-title">Markedsoversikt</div>
  <div class="section-sub" id="kpi-subtitle">LASTER EU AGRIDATA...</div>
  <div class="kpi-grid" id="kpi-grid"></div>

  <div id="chart-area"></div>
  <div class="bottom-grid" id="detail-panels"></div>

  <div class="panel-card" style="margin-bottom:16px">
    <div class="panel-title"><div class="panel-icon" style="background:rgba(74,222,128,.12)">üìä</div>Ukentlig prisendring ‚Äî alle produkter</div>
    <div class="compare-wrap"><canvas id="compare-chart"></canvas></div>
  </div>
</div>

<!-- ==================== TAB: MARKEDSDRIVERE ==================== -->
<div class="tab-panel" id="tab-drivere">

  <div class="driver-section-title">Makroindikatorer</div>
  <div class="driver-section-sub">Valuta, energi og fraktdata ¬∑ Oppdateres via live API ¬∑ Indirekte p√•virkning p√• innkj√∏pspriser</div>

  <div class="drivers-grid" id="drivers-grid"></div>

  <div class="impact-matrix">
    <div class="matrix-title">Prisdriver-matrise ‚Äî hvilke produkter p√•virkes av hva</div>
    <table class="matrix-table">
      <thead>
        <tr>
          <th>Produkt</th>
          <th>EUR/USD</th>
          <th>Energi NL</th>
          <th>Frakt</th>
          <th>T√∏rke/Frost</th>
          <th>TR4 (banan)</th>
        </tr>
      </thead>
      <tbody id="impact-matrix-body"></tbody>
    </table>
  </div>


</div>

<!-- ==================== TAB: CSV/DATA OPPLASTING ==================== -->
<div class="tab-panel" id="tab-pdf">

  <div class="driver-section-title">Last opp prisdata manuelt</div>
  <div class="driver-section-sub">CSV FRA DEFRA, EU AGRIDATA ELLER EGNE EXCEL-EKSPORTER ¬∑ Oppdaterer dashboard direkte</div>

  <!-- UPLOAD AREA -->
  <div id="csv-upload-area" style="border:2px dashed rgba(255,255,255,0.15);border-radius:16px;padding:40px;text-align:center;cursor:pointer;transition:all .2s;margin-bottom:20px;background:rgba(59,130,246,0.03)"
    ondragover="event.preventDefault();this.style.borderColor='#3b82f6'"
    ondragleave="this.style.borderColor='rgba(255,255,255,0.15)'"
    ondrop="handleCsvDrop(event)"
    onclick="document.getElementById('csv-file-input').click()">
    <div style="font-size:48px;margin-bottom:12px">üìä</div>
    <div style="font-family:'DM Serif Display',serif;font-size:20px;margin-bottom:8px">Last opp CSV-fil med prisdata</div>
    <div style="font-size:12px;color:var(--text3);line-height:1.8">
      Dra og slipp CSV her, eller klikk for √• velge fil<br>
      <span style="color:var(--text2)">St√∏ttede formater: UK DEFRA, EU Agridata eksport, egendefinert</span>
    </div>
    <input type="file" id="csv-file-input" accept=".csv,.txt" style="display:none" onchange="handleCsvFile(this.files[0])">
  </div>

  <!-- FORMAT INFO -->
  <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:20px">
    <div class="panel-card">
      <div class="panel-title">üìã UK DEFRA format</div>
      <div style="font-size:11px;color:var(--text2);line-height:1.7;font-family:'DM Mono',monospace">
        category, item, variety,<br>date, price, unit<br>
        <span style="color:var(--text3)">Pris i GBP/kg ‚Äî konverteres automatisk til EUR/100kg</span>
      </div>
    </div>
    <div class="panel-card">
      <div class="panel-title">üìã EU Agridata format</div>
      <div style="font-size:11px;color:var(--text2);line-height:1.7;font-family:'DM Mono',monospace">
        product, week, year,<br>price_eur, stage<br>
        <span style="color:var(--text3)">Pris i EUR/100kg ‚Äî brukes direkte</span>
      </div>
    </div>
    <div class="panel-card">
      <div class="panel-title">üìã Egendefinert format</div>
      <div style="font-size:11px;color:var(--text2);line-height:1.7;font-family:'DM Mono',monospace">
        product, price, date<br>
        (+ valgfritt: unit, stage)<br>
        <span style="color:var(--text3)">Produkt-navn mappes automatisk</span>
      </div>
    </div>
  </div>

  <div id="csv-status" style="display:none;padding:14px;border-radius:10px;margin-bottom:20px;font-size:12px;font-family:'DM Mono',monospace"></div>

  <!-- PREVIEW -->
  <div id="csv-results" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:8px">
      <div>
        <div style="font-family:'DM Serif Display',serif;font-size:18px">Forh√•ndsvisning ‚Äî importerte priser</div>
        <div id="csv-source-label" style="font-size:10px;color:var(--text3);font-family:'DM Mono',monospace"></div>
      </div>
      <div style="display:flex;gap:8px">
        <button onclick="cancelCsvImport()" style="padding:8px 16px;background:rgba(248,113,113,.15);border:1px solid rgba(248,113,113,.3);border-radius:8px;color:#f87171;font-size:12px;font-family:'DM Mono',monospace;cursor:pointer">
          ‚úï Avbryt
        </button>
        <button onclick="applyCsvPrices()" style="padding:8px 18px;background:var(--accent);border:none;border-radius:8px;color:white;font-size:12px;font-family:'DM Mono',monospace;cursor:pointer;font-weight:500">
          ‚úÖ Bruk disse prisene
        </button>
      </div>
    </div>
    <div id="csv-price-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px"></div>

    <!-- RAW PREVIEW -->
    <div style="margin-top:20px">
      <div style="font-family:'DM Serif Display',serif;font-size:15px;margin-bottom:8px">R√• CSV-data (f√∏rste 5 rader)</div>
      <div id="csv-raw-preview" style="background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:14px;font-size:11px;font-family:'DM Mono',monospace;color:var(--text2);overflow-x:auto;white-space:pre;line-height:1.7"></div>
    </div>
  </div>

  <!-- ANDRE DATAKILDER -->
  <div style="margin-top:24px">
    <div class="driver-section-title">Andre tilgjengelige datakilder</div>
    <div class="driver-section-sub">√ÖPNE KILDER SOM KAN LASTES OPP SOM CSV ¬∑ Ingen IP-blokkering ¬∑ Gratis tilgang</div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;margin-top:12px">
      
      <div class="panel-card" style="border-left:3px solid #4ade80">
        <div class="panel-title">üá¨üáß UK DEFRA</div>
        <div style="font-size:11px;color:var(--text2);line-height:1.7">Ukentlig CSV med grossistpriser for frukt/gr√∏nt. Dekker 12 av v√•re produkter. Oppdateres tirsdager.<br>
        <span style="color:var(--text3)">Dekning: eple, p√¶re, jordb√¶r, bringeb√¶r, bl√•b√¶r, kirseb√¶r, tomat, agurk, paprika, gulrot, brokkoli, blomk√•l</span></div>
        <a href="https://www.gov.uk/government/statistical-data-sets/wholesale-fruit-and-vegetable-prices-weekly-average" target="_blank" style="display:inline-block;margin-top:8px;font-size:10px;font-family:'DM Mono',monospace;color:#60a5fa">‚Üí Last ned fra gov.uk</a>
      </div>

      <div class="panel-card" style="border-left:3px solid #60a5fa">
        <div class="panel-title">üá™üá∫ EU Agridata (manuell)</div>
        <div style="font-size:11px;color:var(--text2);line-height:1.7">EU Agridata blokkerer automatisk henting, men CSV-eksport fungerer fra nettleseren. Velg produkt ‚Üí eksporter ukentlige priser.<br>
        <span style="color:var(--text3)">Dekning: alle 19 produkter ¬∑ Prisniv√•: ex-packaging, farmgate, retail</span></div>
        <a href="https://agridata.ec.europa.eu/extensions/DashboardFruitsVegetables/FruitsVegetablesMarkets.html" target="_blank" style="display:inline-block;margin-top:8px;font-size:10px;font-family:'DM Mono',monospace;color:#60a5fa">‚Üí √Öpne EU Agridata</a>
      </div>

      <div class="panel-card" style="border-left:3px solid #fb923c">
        <div class="panel-title">üá©üá™ AMI Marktbericht (DE)</div>
        <div style="font-size:11px;color:var(--text2);line-height:1.7">Tysk Agrarmarkt Informations-Gesellschaft. Ukentlige markedsrapporter for frukt/gr√∏nt. Gratis registrering kreves.<br>
        <span style="color:var(--text3)">Dekning: tomat, agurk, paprika, eple, salat ‚Äî tyske grossistmarkeder</span></div>
        <a href="https://www.ami-informiert.de" target="_blank" style="display:inline-block;margin-top:8px;font-size:10px;font-family:'DM Mono',monospace;color:#60a5fa">‚Üí ami-informiert.de</a>
      </div>

      <div class="panel-card" style="border-left:3px solid #fbbf24">
        <div class="panel-title">üá≥üá± CBS / NFO (NL)</div>
        <div style="font-size:11px;color:var(--text2);line-height:1.7">Nederlandsk CBS statistik og NFO (Nederlandse Fruit en Groente Organisatie) publiserer auksjonsdata. Spesielt relevant for veksthusprodukter.<br>
        <span style="color:var(--text3)">Dekning: tomat, agurk, paprika, salat ‚Äî Venlo/Westland auksjoner</span></div>
        <a href="https://www.nfo.nl" target="_blank" style="display:inline-block;margin-top:8px;font-size:10px;font-family:'DM Mono',monospace;color:#60a5fa">‚Üí nfo.nl</a>
      </div>

      <div class="panel-card" style="border-left:3px solid #e879f9">
        <div class="panel-title">üá≤üá¶ Freshplaza / Fruitnet</div>
        <div style="font-size:11px;color:var(--text2);line-height:1.7">Handelsmedier med ukentlige prisrapporter for Marokko (jordb√¶r, bringeb√¶r, tomat) og Spania (Huelva, Almer√≠a). Ingen CSV ‚Äî brukes som kontekst.<br>
        <span style="color:var(--text3)">Kilde for kvalitativ sesong- og markedsinformasjon</span></div>
        <a href="https://www.freshplaza.com" target="_blank" style="display:inline-block;margin-top:8px;font-size:10px;font-family:'DM Mono',monospace;color:#60a5fa">‚Üí freshplaza.com</a>
      </div>

      <div class="panel-card" style="border-left:3px solid #f87171">
        <div class="panel-title">üåç FAO FAOSTAT</div>
        <div style="font-size:11px;color:var(--text2);line-height:1.7">FN matorganisasjon. Historiske produsentpriser per land og produkt. Oppdateres kvartalsvis ‚Äî egnet for langsiktig trendsanalyse.<br>
        <span style="color:var(--text3)">Last ned CSV direkte fra bulkdownloads</span></div>
        <a href="https://www.fao.org/faostat/en/#data/PP" target="_blank" style="display:inline-block;margin-top:8px;font-size:10px;font-family:'DM Mono',monospace;color:#60a5fa">‚Üí FAOSTAT produsentpriser</a>
      </div>

    </div>
  </div>

</div>

</div>
</div>
</div>

<script>
// ============================================================
// PRODUKTKONFIGURASJON
// ============================================================
const PRODUCT_CONFIG = {
  avocado:     {name:'Avokado',   emoji:'ü•ë',color:'#4ade80',cat:'frukt',euProduct:'Avocados',      unit:'/kg',hasIndex:true },
  strawberry:  {name:'Jordb√¶r',   emoji:'üçì',color:'#f87171',cat:'baer', euProduct:'Strawberries',  unit:'/kg',hasIndex:true },
  raspberry:   {name:'Bringeb√¶r', emoji:'ü´ê',color:'#e879f9',cat:'baer', euProduct:'Raspberries',   unit:'/kg',hasIndex:true },
  banana:      {name:'Banan',     emoji:'üçå',color:'#fef08a',cat:'frukt',euProduct:'Bananas',       unit:'/kg',hasIndex:true },
  tomato:      {name:'Tomat',     emoji:'üçÖ',color:'#f97316',cat:'gronn',euProduct:'Tomatoes',      unit:'/kg',hasIndex:true },
  apple:       {name:'Eple',      emoji:'üçé',color:'#ef4444',cat:'frukt',euProduct:'Apples',        unit:'/kg',hasIndex:true },
  orange:      {name:'Appelsin',  emoji:'üçä',color:'#fb923c',cat:'frukt',euProduct:'Oranges',       unit:'/kg',hasIndex:true },
  pepper:      {name:'Paprika',   emoji:'ü´ë',color:'#fcd34d',cat:'gronn',euProduct:'Sweet peppers', unit:'/kg',hasIndex:true },
  cucumber:    {name:'Agurk',     emoji:'ü•í',color:'#22c55e',cat:'gronn',euProduct:'Cucumbers',     unit:'/kg',hasIndex:true },
  lettuce:     {name:'Isbergsalat',emoji:'ü•¨',color:'#34d399',cat:'gronn',euProduct:'Lettuces',     unit:'/hd',hasIndex:true},
  grape:       {name:'Druer',     emoji:'üçá',color:'#a78bfa',cat:'frukt',euProduct:'Table grapes',  unit:'/kg',hasIndex:true },
  cauliflower: {name:'Blomk√•l',   emoji:'ü•¶',color:'#e2e8f0',cat:'gronn',euProduct:'Cauliflowers',  unit:'/st',hasIndex:true},
  carrot:      {name:'Gulrot',    emoji:'ü•ï',color:'#fb923c',cat:'gronn',euProduct:'Carrots',       unit:'/kg',hasIndex:true },
  blueberry:   {name:'Bl√•b√¶r',    emoji:'ü´ê',color:'#818cf8',cat:'baer', euProduct:'Blueberries',   unit:'/kg',hasIndex:true },
  cherry:      {name:'Kirseb√¶r',  emoji:'üçí',color:'#f43f5e',cat:'baer', euProduct:'Cherries',      unit:'/kg',hasIndex:true },
  pear:        {name:'P√¶re',      emoji:'üçê',color:'#a3e635',cat:'frukt',euProduct:'Pears',         unit:'/kg',hasIndex:true },
  broccoli:    {name:'Brokkoli',  emoji:'ü•¶',color:'#16a34a',cat:'gronn',euProduct:'Broccoli',      unit:'/kg',hasIndex:true },
  mango:       {name:'Mango',     emoji:'ü•≠',color:'#fcd34d',cat:'frukt',euProduct:null,            unit:'/kg',hasIndex:false},
  peach:       {name:'Fersken',   emoji:'üçë',color:'#fbbf24',cat:'frukt',euProduct:'Peaches',       unit:'/kg',hasIndex:true },
  // SOPP
  champignon:  {name:'Champignon',emoji:'üçÑ',color:'#d4b896',cat:'sopp', euProduct:null,            unit:'/kg',hasIndex:false},
  shiitake:    {name:'Shiitake',  emoji:'üçÑ',color:'#c8a87a',cat:'sopp', euProduct:null,            unit:'/kg',hasIndex:false},
  oyster:      {name:'√òsterssopp',emoji:'üçÑ',color:'#b8c4cc',cat:'sopp', euProduct:null,            unit:'/kg',hasIndex:false},
};

const SEASONAL_BASE = {
  avocado:    [155,158,170,165,162,180,210,220,205,185,170,160],
  strawberry: [480,420,350,280,240,220,350,420,480,520,550,510],
  raspberry:  [620,600,580,520,480,450,420,460,550,600,640,630],
  banana:     [94,93,92,91,90,89,88,89,90,92,94,95],
  tomato:     [130,120,110,100,95,90,95,105,115,125,135,135],
  apple:      [160,155,150,145,140,135,130,135,145,160,170,165],
  orange:     [140,120,105,95,90,85,80,82,90,100,120,140],
  pepper:     [220,190,170,150,140,130,140,160,190,210,230,230],
  cucumber:   [58,55,52,48,45,42,44,48,52,56,60,60],
  lettuce:    [68,70,65,60,58,55,60,65,70,75,78,75],
  grape:      [350,320,300,280,260,240,230,250,280,320,360,370],
  cauliflower:[105,100,95,88,82,78,80,85,92,100,108,108],
  carrot:     [80,78,76,74,72,70,68,70,72,76,80,82],
  blueberry:  [750,720,690,650,600,550,520,580,650,700,740,760],
  cherry:     [950,900,800,700,650,600,800,950,1000,1050,1100,1050],
  pear:       [130,125,120,115,110,105,100,105,115,125,135,135],
  broccoli:   [110,115,120,125,130,135,140,135,125,115,108,108],
  mango:      [170,165,160,155,150,155,165,175,180,180,175,172],
  peach:      [350,320,290,260,230,210,190,210,280,350,400,380],
  // Sopp ‚Äî europeiske produsentpriser (Nederland/Polen)
  champignon: [195,190,185,180,175,172,170,175,182,188,196,198],
  shiitake:   [520,510,500,490,480,475,470,480,492,505,518,524],
  oyster:     [380,375,368,360,355,350,348,355,365,373,382,385],
};

// ============================================================
// MARKEDSDRIVERE KONFIGURASJON
// ============================================================
const DRIVER_CONFIG = [
  {
    id:'eurusd', name:'EUR/USD', emoji:'üí±', category:'Valuta',
    apiUrl:'https://api.frankfurter.app/latest?from=EUR&to=USD',
    parse: d => d.rates.USD,
    format: v => v.toFixed(4),
    unit:'',
    impact: v => v < 1.05 ? 'neg' : v > 1.12 ? 'pos' : 'neu',
    impactText: v => v < 1.05 ? '‚Üë Importkostnad' : v > 1.12 ? '‚Üì Billigere import' : '‚Üí N√∏ytralt',
    desc: 'Lav EUR/USD betyr dyrere USD-prissatt import (banan, avokado, mango). Hver 5% USD-styrking gir ca. 3-4% h√∏yere innkj√∏pspris.',
    products:['banan','avokado','mango'],
    color:'#60a5fa'
  },
  {
    id:'eurnok', name:'EUR/NOK', emoji:'üá≥üá¥', category:'Valuta',
    apiUrl:'https://api.frankfurter.app/latest?from=EUR&to=NOK',
    parse: d => d.rates.NOK,
    format: v => v.toFixed(2),
    unit:'',
    impact: v => v > 11.8 ? 'neg' : v < 11.0 ? 'pos' : 'neu',
    impactText: v => v > 11.8 ? '‚Üë NOK svak' : v < 11.0 ? '‚Üì NOK sterk' : '‚Üí Stabilt',
    desc: 'Svak NOK √∏ker alle importkostnader for BAMA direkte. EUR/NOK over 11.80 er ugunstig for norsk innkj√∏p av EU-varer.',
    products:['alle EU-varer'],
    color:'#f87171'
  },
  {
    id:'brent', name:'Brent r√•olje', emoji:'üõ¢Ô∏è', category:'Energi/Frakt',
    apiUrl: null, // Bruker estimert ‚Äî krever betalt API
    fallback: 78.4,
    format: v => '$' + v.toFixed(1),
    unit:'/fat',
    impact: v => v > 85 ? 'neg' : v < 70 ? 'pos' : 'neu',
    impactText: v => v > 85 ? '‚Üë Fraktkostnader' : v < 70 ? '‚Üì Lavere frakt' : '‚Üí Normalt',
    desc: 'Oljepris driver fraktkostnader direkte. Sj√∏frakt Ecuador‚ÜíEuropa og lastebil Spania‚ÜíNorge utgj√∏r 8-15% av innkj√∏pspris.',
    products:['banan','avokado','mango','b√¶r'],
    color:'#fb923c'
  },
  {
    id:'nlgas', name:'NL Naturgass', emoji:'‚ö°', category:'Energi/Frakt',
    apiUrl: null,
    fallback: 42.8,
    format: v => '‚Ç¨' + v.toFixed(1),
    unit:'/MWh TTF',
    impact: v => v > 45 ? 'neg' : v < 30 ? 'pos' : 'neu',
    impactText: v => v > 45 ? '‚Üë Veksthuspres' : v < 30 ? '‚Üì Lavere kostnad' : '‚Üí Normalt',
    desc: 'Nederlandske veksthus bruker naturgass til oppvarming og CO‚ÇÇ-tilf√∏rsel. H√∏y gasspris presser tomat, agurk, paprika og salat fra NL.',
    products:['tomat','agurk','paprika','salat'],
    color:'#fbbf24'
  },
  {
    id:'fao', name:'FAO Food Price', emoji:'üåæ', category:'Globalt',
    apiUrl: null,
    fallback: 127.4,
    format: v => v.toFixed(1),
    unit:'(2014-16=100)',
    impact: v => v > 130 ? 'neg' : v < 110 ? 'pos' : 'neu',
    impactText: v => v > 130 ? '‚Üë Globalt prispress' : v < 110 ? '‚Üì Moderate priser' : '‚Üí Stabilt',
    desc: 'FAO Food Price Index m√•ler m√•nedlige endringer i internasjonale matpriser. H√∏ye niv√•er signaliserer bredt prispress i supply chain.',
    products:['alle produkter'],
    color:'#4ade80'
  },
  {
    id:'baltic', name:'Baltic Dry Index', emoji:'üö¢', category:'Energi/Frakt',
    apiUrl: null,
    fallback: 1340,
    format: v => Math.round(v).toString(),
    unit:'poeng',
    impact: v => v > 1500 ? 'neg' : v < 1000 ? 'pos' : 'neu',
    impactText: v => v > 1500 ? '‚Üë H√∏ye fraktrater' : v < 1000 ? '‚Üì Billig frakt' : '‚Üí Normalt',
    desc: 'Baltic Dry Index m√•ler globale t√∏rlastfraktrater. H√∏ye verdier p√•virker kostnad for langdistanseimport (banan, mango, eksotisk frukt).',
    products:['banan','mango','druer','bl√•b√¶r'],
    color:'#38bdf8'
  },
];

// Impact matrise
const IMPACT_MATRIX = [
  {product:'üçå Banan',     eurusd:'high-neg', energy:'low',     freight:'high-neg', weather:'low',  tr4:'high-neg'},
  {product:'ü•ë Avokado',   eurusd:'high-neg', energy:'low',     freight:'med-neg',  weather:'med',  tr4:'none'},
  {product:'üçì Jordb√¶r',   eurusd:'low',      energy:'med-neg', freight:'med-neg',  weather:'high', tr4:'none'},
  {product:'üçÖ Tomat',     eurusd:'none',     energy:'high-neg',freight:'low',      weather:'med',  tr4:'none'},
  {product:'ü•í Agurk',     eurusd:'none',     energy:'high-neg',freight:'low',      weather:'med',  tr4:'none'},
  {product:'ü´ë Paprika',   eurusd:'low',      energy:'high-neg',freight:'low',      weather:'med',  tr4:'none'},
  {product:'ü´ê Bringeb√¶r', eurusd:'low',      energy:'low',     freight:'med-neg',  weather:'high', tr4:'none'},
  {product:'ü´ê Bl√•b√¶r',   eurusd:'med-neg',  energy:'low',     freight:'high-neg', weather:'med',  tr4:'none'},
  {product:'ü•≠ Mango',     eurusd:'high-neg', energy:'low',     freight:'high-neg', weather:'low',  tr4:'none'},
  {product:'üçÑ Champignon',eurusd:'none',     energy:'med-neg', freight:'low',      weather:'pos',  tr4:'none'},
];

// ============================================================
// STATE
// ============================================================
let liveData = {};
let driverData = {};
let currentProduct = 'avocado';
let currentStage = 'Ex-packaging station price';
let currentFilter = 'all';
let dataLoaded = false;
let mainChart = null;
let compareChart = null;
let driverCharts = {};
let currentTab = 'priser';

// ============================================================
// HJELPER
// ============================================================
function getWeekNumber(d){
  const date=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate()));
  const dayNum=date.getUTCDay()||7;
  date.setUTCDate(date.getUTCDate()+4-dayNum);
  const yearStart=new Date(Date.UTC(date.getUTCFullYear(),0,1));
  return Math.ceil((((date-yearStart)/86400000)+1)/7);
}
function currentWeek(){return getWeekNumber(new Date());}

// ============================================================
// DATAKILDE: GitHub prices.json (hentet av GitHub Actions ukentlig)
// ============================================================
const PRICES_JSON_URL = 'https://raw.githubusercontent.com/klister-no/freshindex/main/prices.json';

function generateFallback(key,weeks=26){
  const base=SEASONAL_BASE[key]||SEASONAL_BASE.tomato;
  const prices=[],labels=[];
  const now=new Date();
  for(let i=weeks;i>=0;i--){
    const d=new Date(now);d.setDate(d.getDate()-i*7);
    const b=base[d.getMonth()];
    prices.push(Math.round((b+(Math.random()-.5)*b*.04)*100)/100);
    labels.push(`Uke ${getWeekNumber(d)} ${d.getFullYear()}`);
  }
  return{prices,labels};
}


function calcChange(prices){
  if(prices.length<2)return 0;
  return Math.round(((prices[prices.length-1]-prices[prices.length-2])/prices[prices.length-2])*1000)/10;
}

// ============================================================
// LOAD PRODUKT DATA ‚Äî fra GitHub prices.json (oppdatert ukentlig via Actions)
// ============================================================
async function loadAllData(){
  updateStatus('loading');
  // Steg 1: Vis sesong-estimater umiddelbart s√• siden ikke er tom
  Object.entries(PRODUCT_CONFIG).forEach(([key])=>{
    const fb=generateFallback(key,26);
    liveData[key]={...fb,latest:fb.prices[fb.prices.length-1],weekChange:calcChange(fb.prices),source:'estimert'};
  });
  dataLoaded=true;renderAll();

  // Steg 2: Hent prices.json fra GitHub
  try{
    const res=await fetch(PRICES_JSON_URL+'?t='+Date.now());
    if(!res.ok)throw new Error('HTTP '+res.status);
    const json=await res.json();

    let liveCount=0;
    Object.entries(json.products||{}).forEach(([key,d])=>{
      if(d&&d.prices&&d.prices.length>2){
        liveData[key]={prices:d.prices,labels:d.labels,latest:d.latest,weekChange:d.weekChange,source:'live'};
        liveCount++;
      }
    });

    renderSidebar();renderKpiGrid(currentFilter);
    buildMainChart(currentProduct,'6m');buildDetailPanels(currentProduct);

    const fetched=json.fetched?new Date(json.fetched).toLocaleDateString('no-NO',{day:'2-digit',month:'2-digit',year:'numeric'}):'ukjent';
    if(liveCount>0){
      updateStatus('live',`${liveCount} LIVE ¬∑ Uke ${json.week} ${json.year}`);
      showBanner('ok',`‚úÖ ${liveCount} produkter med EU Agridata-priser. Sist oppdatert ${fetched}.`);
    }else{
      updateStatus('fallback','SESONG-ESTIMAT');
      showBanner('warn','‚ö†Ô∏è prices.json er tom eller ikke generert enn√•. Kj√∏r GitHub Actions workflow manuelt f√∏rste gang.');
    }
  }catch(e){
    // prices.json ikke tilgjengelig enn√• ‚Äî estimater vises allerede
    updateStatus('fallback','SESONG-ESTIMAT');
    showBanner('warn','‚ö†Ô∏è prices.json ikke funnet enn√•. Kj√∏r GitHub Actions workflow manuelt: Actions ‚Üí Fetch EU Agridata Weekly ‚Üí Run workflow.');
  }
  buildCompareChart();
}

// ============================================================
// LOAD DRIVER DATA (valuta etc.)
// ============================================================
async function loadDriverData(){
  // Fetch GBP/EUR rate for CSV DEFRA conversion
  try{
    const r=await fetch('https://api.frankfurter.app/latest?from=GBP&to=EUR');
    if(r.ok){const j=await r.json();window._gbpEurRate=j.rates.EUR;}
  }catch(e){}

  for(const driver of DRIVER_CONFIG){
    if(!driver.apiUrl){
      driverData[driver.id]={value:driver.fallback,source:'estimert',history:generateDriverHistory(driver.fallback,12)};
      continue;
    }
    try{
      const res=await fetch(driver.apiUrl);
      if(res.ok){
        const json=await res.json();
        const val=driver.parse(json);
        driverData[driver.id]={value:val,source:'live',history:generateDriverHistory(val,12)};
      }
    }catch(e){
      driverData[driver.id]={value:driver.fallback,source:'estimert',history:generateDriverHistory(driver.fallback,12)};
    }
  }
  renderDriversTab();
  renderSidebarDrivers();
  updateRatesHeader();
}

function generateDriverHistory(current,weeks){
  const h=[];
  for(let i=weeks;i>=0;i--){
    const noise=(Math.random()-.5)*.03;
    h.push(Math.round(current*(1+noise*(weeks-i)/weeks)*10000)/10000);
  }
  h[h.length-1]=current;
  return h;
}

function updateRatesHeader(){
  const eurusd=driverData['eurusd'];
  const eurnok=driverData['eurnok'];
  if(eurusd&&eurnok){
    document.getElementById('rates-header').textContent=
      `EUR/USD ${eurusd.value.toFixed(4)} ¬∑ EUR/NOK ${eurnok.value.toFixed(2)} ¬∑ Brent $${driverData['brent']?.value.toFixed(1)||'--'}`;
  }
}

// ============================================================
// STATUS / BANNER
// ============================================================
function updateStatus(type,text){
  const el=document.getElementById('data-status');
  el.className='data-status';
  if(type==='live'){el.classList.add('status-live');el.textContent=text||'LIVE DATA';}
  else if(type==='loading'){el.classList.add('status-loading');el.innerHTML='<span class="spinner"></span>HENTER DATA';}
  else{el.classList.add('status-fallback');el.textContent=text||'ESTIMERT';}
  const now=new Date();
  document.getElementById('week-label').textContent=`UKE ${currentWeek()} ¬∑ ${now.getFullYear()}`;
}

function showBanner(type,msg){
  const el=document.getElementById('api-banner');
  el.className=`api-banner ${type} show`;el.innerHTML=msg;
}

// ============================================================
// TABS
// ============================================================
function switchTab(tab,btn){
  currentTab=tab;
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('tab-'+tab).classList.add('active');
}

// ============================================================
// SIDEBAR
// ============================================================
function renderSidebar(){
  const cats={frukt:'üçé Frukt',baer:'ü´ê B√¶r',gronn:'ü•¨ Gr√∏nnsaker',sopp:'üçÑ Sopp'};
  const grouped={frukt:[],baer:[],gronn:[],sopp:[]};
  Object.entries(PRODUCT_CONFIG).forEach(([k,c])=>grouped[c.cat]?.push([k,c]));
  let html='';
  Object.entries(cats).forEach(([catKey,catLabel])=>{
    html+=`<div class="cat-label">${catLabel}</div>`;
    grouped[catKey].forEach(([key,cfg])=>{
      const d=liveData[key];
      const price=d?d.latest:null;
      const chg=d?d.weekChange:null;
      const src=d?d.source:'loading';
      const chgCls=!chg?'change-neutral':chg>0?'change-up':'change-down';
      const chgTxt=chg!==null?`${chg>0?'+':''}${chg}%${chg>0?'‚Üë':chg<0?'‚Üì':'‚Üí'}`:'...';
      const srcLabel = src==='live'
        ? (d.sourceNote&&d.sourceNote.includes('DEFRA')?'üá¨üáß UK':'üá™üá∫ EU')
        : src==='csv'?'üìä CSV':src==='pdf'?'üìÑ PDF':'‚óã EST';
      const srcCls = src==='live'?'product-sub-live':(src==='csv'||src==='pdf')?'product-sub-csv':'product-sub';
      html+=`<button class="product-btn${key===currentProduct?' active':''}" onclick="selectProduct('${key}')">
        <div class="color-stripe" style="background:${cfg.color}"></div>
        <span class="product-emoji">${cfg.emoji}</span>
        <div class="product-info">
          <div class="product-name">${cfg.name}</div>
          <div class="product-sub ${srcCls}">${srcLabel}</div>
        </div>
        <div class="product-price-col">
          <div class="product-price" style="color:${cfg.color}">${price!==null?'‚Ç¨'+(price/100).toFixed(2):'¬∑¬∑¬∑'}</div>
          <div class="product-change ${chgCls}">${chgTxt}</div>
        </div>
      </button>`;
    });
  });
  document.getElementById('sidebar-products').innerHTML=html;
}

function renderSidebarDrivers(){
  let html='';
  DRIVER_CONFIG.slice(0,4).forEach(cfg=>{
    const d=driverData[cfg.id];
    if(!d)return;
    const imp=cfg.impact(d.value);
    const impTxt=cfg.impactText(d.value);
    const impCls=imp==='neg'?'impact-neg':imp==='pos'?'impact-pos':'impact-neu';
    html+=`<div class="driver-mini-item">
      <span class="driver-mini-name">${cfg.emoji} ${cfg.name}</span>
      <span>
        <span class="driver-mini-val" style="color:${cfg.color}">${cfg.format(d.value)}</span>
        <span class="driver-mini-impact ${impCls}">${impTxt.split(' ')[0]}</span>
      </span>
    </div>`;
  });
  document.getElementById('sidebar-drivers').innerHTML=html;
}

// ============================================================
// KPI GRID
// ============================================================
function renderKpiGrid(filter){
  const now=new Date();
  document.getElementById('kpi-subtitle').textContent=
    `EU AGRIDATA ¬∑ ${currentStage.toUpperCase().replace(' PRICE','')} ¬∑ UKE ${currentWeek()}, ${now.getFullYear()}`;
  const grid=document.getElementById('kpi-grid');
  grid.innerHTML='';
  let i=0;
  Object.entries(PRODUCT_CONFIG).forEach(([key,cfg])=>{
    if(filter!=='all'&&cfg.cat!==filter)return;
    const d=liveData[key];
    const price=d?d.latest:null;
    const chg=d?d.weekChange:null;
    const src=d?d.source:'loading';
    const badgeCls=!chg?'badge-neutral':chg>1?'badge-up':chg<-1?'badge-down':'badge-neutral';
    const card=document.createElement('div');
    card.className=`kpi-card${key===currentProduct?' selected':''}`;
    card.style.animationDelay=(i*.02)+'s';
    card.style.borderBottom=`2px solid ${cfg.color}`;
    card.innerHTML=`
      <div class="kpi-top"><div class="kpi-label">${cfg.name}</div><div class="kpi-emoji">${cfg.emoji}</div></div>
      <div class="kpi-price" style="color:${cfg.color}">${price!==null?(price/100).toFixed(2):'¬∑¬∑¬∑'}<span class="kpi-unit"> ‚Ç¨${cfg.unit}</span></div>
      <div class="kpi-meta">
        <span class="kpi-badge ${badgeCls}">${chg!==null?(chg>0?'+':'')+chg+'% 7d':'¬∑¬∑¬∑'}</span>
        <span class="kpi-badge ${src==='live'?'badge-live':'badge-est'}">${src==='live'?'LIVE':'EST'}</span>
      </div>
      <div class="sparkline-container"><canvas id="spark-${key}"></canvas></div>`;
    card.addEventListener('click',()=>selectProduct(key));
    grid.appendChild(card);i++;
    if(d)setTimeout(()=>drawSparkline(`spark-${key}`,d.prices.slice(-10),cfg.color),60*i);
  });
}

function drawSparkline(id,data,color){
  const c=document.getElementById(id);if(!c)return;
  new Chart(c,{type:'line',data:{labels:data.map((_,i)=>i),datasets:[{data,borderColor:color,borderWidth:1.5,pointRadius:0,tension:.4,fill:false}]},
  options:{responsive:true,maintainAspectRatio:false,animation:false,plugins:{legend:{display:false},tooltip:{enabled:false}},scales:{x:{display:false},y:{display:false}}}});
}

// ============================================================
// MAIN CHART
// ============================================================
function buildMainChart(key,range){
  const cfg=PRODUCT_CONFIG[key];const d=liveData[key];if(!d)return;
  const rangeMap={'3m':13,'6m':26,'1y':52,'3y':156};
  const weeks=rangeMap[range]||26;
  let prices,labels;
  if(d.prices.length>=weeks){prices=d.prices.slice(-weeks-1);labels=d.labels.slice(-weeks-1);}
  else{const fb=generateFallback(key,weeks);prices=fb.prices;labels=fb.labels;}

  document.getElementById('chart-area').innerHTML=`
    <div class="chart-section">
      <div class="chart-header">
        <div>
          <div class="chart-title">${cfg.emoji} ${cfg.name} ‚Äî Prisutvikling</div>
          <div class="chart-subtitle">${d.source==='live'?'‚óè LIVE DATA':'‚óã SESONG-ESTIMAT'} ¬∑ ${currentStage.toUpperCase()} ¬∑ EUR/KG</div>
        </div>
        <div class="chart-controls">
          <button class="ctrl-btn${range==='3m'?' active':''}" onclick="setRange('3m',this)">3M</button>
          <button class="ctrl-btn${range==='6m'?' active':''}" onclick="setRange('6m',this)">6M</button>
          <button class="ctrl-btn${range==='1y'?' active':''}" onclick="setRange('1y',this)">1√Ö</button>
          <button class="ctrl-btn${range==='3y'?' active':''}" onclick="setRange('3y',this)">3√Ö</button>
        </div>
      </div>
      <div class="chart-wrap"><canvas id="main-chart"></canvas></div>
      <div class="forecast-legend">
        <div class="legend-item"><div style="width:16px;height:2px;background:${cfg.color}"></div>Historisk pris</div>
        <div style="margin-left:auto;color:var(--text3)">${d.source==='live'?'‚úÖ Live data':'‚ö†Ô∏è Sesong-estimat'}</div>
      </div>
    </div>`;

  const ctx=document.getElementById('main-chart').getContext('2d');
  const grad=ctx.createLinearGradient(0,0,0,240);
  grad.addColorStop(0,cfg.color+'28');grad.addColorStop(1,cfg.color+'00');
  if(mainChart)mainChart.destroy();
  mainChart=new Chart(ctx,{type:'line',data:{labels,datasets:[
    {label:'Historisk',data:prices,borderColor:cfg.color,borderWidth:2.5,pointRadius:0,pointHoverRadius:4,fill:true,backgroundColor:grad,tension:.35}
  ]},options:{responsive:true,maintainAspectRatio:false,
    interaction:{mode:'index',intersect:false},
    plugins:{legend:{display:false},tooltip:{backgroundColor:'#1c2638',borderColor:'rgba(255,255,255,.1)',borderWidth:1,
      titleColor:'#8a95aa',bodyColor:'#e8edf5',titleFont:{family:'DM Mono',size:9},bodyFont:{family:'DM Mono',size:11},padding:8,
      callbacks:{label:c=>c.raw!==null?` Pris: ‚Ç¨${(c.raw/100).toFixed(2)}/kg`:null}}},
    scales:{
      x:{grid:{color:'rgba(255,255,255,.03)'},ticks:{color:'#4e5a70',font:{family:'DM Mono',size:9},maxTicksLimit:10,maxRotation:0},border:{color:'rgba(255,255,255,.05)'}},
      y:{grid:{color:'rgba(255,255,255,.03)'},ticks:{color:'#4e5a70',font:{family:'DM Mono',size:9},callback:v=>'‚Ç¨'+(v/100).toFixed(2)},border:{color:'rgba(255,255,255,.05)'}}
    }}});
}

// ============================================================
// DETAIL PANELS
// ============================================================
function buildDetailPanels(key){
  const cfg=PRODUCT_CONFIG[key];const d=liveData[key];if(!d)return;
  const months=['Jan','Feb','Mar','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Des'];
  const base=SEASONAL_BASE[key]||SEASONAL_BASE.tomato;
  const maxB=Math.max(...base),minB=Math.min(...base);
  const curMon=new Date().getMonth();

  let seasonHtml='<div class="season-grid">';
  base.forEach((v,i)=>{
    const ratio=(v-minB)/(maxB-minB);
    const h=Math.round(10+ratio*30);const op=.2+ratio*.75;
    seasonHtml+=`<div class="season-month"><div class="season-bar${i===curMon?' season-now':''}" style="height:${h}px;background:${cfg.color};opacity:${op}" title="${months[i]}: ‚Ç¨${v}"></div><div class="season-lbl">${months[i][0]}</div></div>`;
  });
  seasonHtml+='</div><div style="font-size:9px;color:var(--text3);font-family:\'DM Mono\',monospace;margin-top:4px">Hvit ramme = n√•v√¶rende m√•ned</div>';




  document.getElementById('detail-panels').innerHTML=`
    <div class="panel-card">
      <div class="panel-title"><div class="panel-icon" style="background:rgba(251,191,36,.12)">üìÖ</div>Sesongindeks</div>
      ${seasonHtml}
    </div>


    <div class="panel-card">
      <div class="panel-title"><div class="panel-icon" style="background:rgba(74,222,128,.12)">‚ÑπÔ∏è</div>Produktinfo</div>
      <div>
        <div class="info-row"><span class="info-key">PRODUKT</span><span style="font-weight:600;color:${cfg.color}">${cfg.emoji} ${cfg.name}</span></div>
        <div class="info-row"><span class="info-key">EU PRODUKT-ID</span><span style="font-family:'DM Mono',monospace;font-size:11px">${cfg.euProduct||'Ikke i EU Agridata'}</span></div>
        <div class="info-row"><span class="info-key">PRISNIV√Ö</span><span style="font-family:'DM Mono',monospace">‚Ç¨${(d.latest/100).toFixed(2)} ${cfg.unit}</span></div>
        <div class="info-row"><span class="info-key">UKENTLIG ENDRING</span><span style="font-family:'DM Mono',monospace;color:${d.weekChange>0?'var(--up)':d.weekChange<0?'var(--down)':'var(--neutral)'}">${d.weekChange>0?'+':''}${d.weekChange}%</span></div>
        <div class="info-row"><span class="info-key">KILDE</span><span style="color:${d.source==='live'?'var(--up)':'var(--neutral)'}">${d.source==='live'?'‚úÖ EU Agridata Live':'‚ö†Ô∏è Sesong-estimat'}</span></div>
        <div class="info-row"><span class="info-key">KATEGORI</span><span>${cfg.cat==='frukt'?'üçé Frukt':cfg.cat==='baer'?'ü´ê B√¶r':cfg.cat==='sopp'?'üçÑ Sopp':'ü•¨ Gr√∏nnsaker'}</span></div>
      </div>
    </div>`;
}

// ============================================================
// COMPARE CHART
// ============================================================
function buildCompareChart(){
  const ctx=document.getElementById('compare-chart').getContext('2d');
  const entries=Object.entries(PRODUCT_CONFIG);
  if(compareChart)compareChart.destroy();
  compareChart=new Chart(ctx,{type:'bar',data:{
    labels:entries.map(([,c])=>`${c.emoji} ${c.name}`),
    datasets:[{data:entries.map(([k])=>liveData[k]?.weekChange??0),
      backgroundColor:entries.map(([,c])=>c.color+'99'),borderColor:entries.map(([,c])=>c.color),borderWidth:1.5,borderRadius:4}]
  },options:{responsive:true,maintainAspectRatio:false,
    plugins:{legend:{display:false},tooltip:{backgroundColor:'#1c2638',borderColor:'rgba(255,255,255,.1)',borderWidth:1,
      titleColor:'#8a95aa',bodyColor:'#e8edf5',titleFont:{family:'DM Mono',size:9},bodyFont:{family:'DM Mono',size:11},padding:7,
      callbacks:{label:c=>` ${c.raw>0?'+':''}${c.raw}% siste uke`}}},
    scales:{
      x:{grid:{display:false},ticks:{color:'#8a95aa',font:{family:'DM Sans',size:9},maxRotation:40},border:{color:'rgba(255,255,255,.05)'}},
      y:{grid:{color:'rgba(255,255,255,.03)'},ticks:{color:'#4e5a70',font:{family:'DM Mono',size:9},callback:v=>v+'%'},border:{color:'rgba(255,255,255,.05)'}}
    }}});
}

// ============================================================
// MARKEDSDRIVERE TAB
// ============================================================
function renderDriversTab(){
  // Drivere
  const grid=document.getElementById('drivers-grid');
  grid.innerHTML='';
  DRIVER_CONFIG.forEach(cfg=>{
    const d=driverData[cfg.id];if(!d)return;
    const imp=cfg.impact(d.value);
    const impTxt=cfg.impactText(d.value);
    const impCls=imp==='neg'?'pill-high-neg':imp==='pos'?'pill-pos':'pill-low';
    const card=document.createElement('div');
    card.className=`driver-card ${imp}`;
    card.innerHTML=`
      <div class="driver-header">
        <div class="driver-name">${cfg.emoji} ${cfg.name}</div>
        <span class="driver-impact-badge ${impCls}">${impTxt}</span>
      </div>
      <div class="driver-value" style="color:${cfg.color}">${cfg.format(d.value)}<span style="font-size:13px;font-family:'DM Sans',sans-serif;color:var(--text3)"> ${cfg.unit}</span></div>
      <div class="driver-desc">${cfg.desc}</div>
      <div class="driver-source">
        <span style="width:5px;height:5px;border-radius:50%;background:${d.source==='live'?'var(--up)':'var(--neutral)'}"></span>
        ${d.source==='live'?'Live data':'Estimert'} ¬∑ ${cfg.category}
        ¬∑ P√•virker: ${cfg.products.join(', ')}
      </div>
      <div class="driver-sparkline"><canvas id="dspk-${cfg.id}"></canvas></div>`;
    grid.appendChild(card);
    setTimeout(()=>drawDriverSparkline(`dspk-${cfg.id}`,d.history,cfg.color),50);
  });

  // Impact matrise
  const tbody=document.getElementById('impact-matrix-body');
  tbody.innerHTML='';
  const pillMap={
    'high-neg':'pill-high-neg','H√∏y negativ':'pill-high-neg',
    'med-neg':'pill-med-neg','mid':'pill-med-neg',
    'low':'pill-low',
    'pos':'pill-pos',
    'none':'pill-none'
  };
  const labelMap={'high-neg':'H√∏y ‚Üë','med-neg':'Middels ‚Üë','low':'Lav','pos':'Positiv ‚Üì','none':'‚Äî'};
  IMPACT_MATRIX.forEach(row=>{
    tbody.innerHTML+=`<tr>
      <td style="font-weight:500">${row.product}</td>
      <td><span class="impact-pill ${pillMap[row.eurusd]||'pill-none'}">${labelMap[row.eurusd]||'‚Äî'}</span></td>
      <td><span class="impact-pill ${pillMap[row.energy]||'pill-none'}">${labelMap[row.energy]||'‚Äî'}</span></td>
      <td><span class="impact-pill ${pillMap[row.freight]||'pill-none'}">${labelMap[row.freight]||'‚Äî'}</span></td>
      <td><span class="impact-pill ${pillMap[row.weather]||'pill-none'}">${labelMap[row.weather]||'‚Äî'}</span></td>
      <td><span class="impact-pill ${pillMap[row.tr4]||'pill-none'}">${labelMap[row.tr4]||'‚Äî'}</span></td>
    </tr>`;
  });

}

function drawDriverSparkline(id,data,color){
  const c=document.getElementById(id);if(!c)return;
  new Chart(c,{type:'line',data:{labels:data.map((_,i)=>i),datasets:[{data,borderColor:color,borderWidth:1.5,pointRadius:0,tension:.4,fill:true,backgroundColor:color+'15'}]},
  options:{responsive:true,maintainAspectRatio:false,animation:false,plugins:{legend:{display:false},tooltip:{enabled:false}},scales:{x:{display:false},y:{display:false}}}});
}

// ============================================================
// INTERAKSJONER
// ============================================================
function selectProduct(key){
  currentProduct=key;
  renderSidebar();renderKpiGrid(currentFilter);
  buildMainChart(key,'6m');buildDetailPanels(key);
  // Bytt til priser-fanen om vi er p√• drivere
  if(currentTab==='drivere'){
    switchTab('priser',document.querySelector('.tab-btn'));
  }
}

function filterCat(cat,btn){
  currentFilter=cat;
  document.querySelectorAll('#cat-row .filter-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');renderKpiGrid(cat);
}

function setStage(stage,btn){
  currentStage=stage;
  document.querySelectorAll('#stage-row .filter-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  liveData={};loadAllData();
}

function setRange(range,btn){
  document.querySelectorAll('.ctrl-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');buildMainChart(currentProduct,range);
}

function renderAll(){
  renderSidebar();renderKpiGrid(currentFilter);
  buildMainChart(currentProduct,'6m');buildDetailPanels(currentProduct);
}

// ============================================================
// START
// ============================================================
// ============================================================
// CSV OPPLASTING OG PARSING
// ============================================================
let extractedCsvPrices = {};

// Produktnavn-mapping fra CSV til interne n√∏kler
const CSV_NAME_MAP = {
  // Engelsk
  'apple':'apple','apples':'apple','pear':'pear','pears':'pear',
  'strawberry':'strawberry','strawberries':'strawberry',
  'raspberry':'raspberry','raspberries':'raspberry',
  'blueberry':'blueberry','blueberries':'blueberry',
  'cherry':'cherry','cherries':'cherry',
  'plum':'peach','plums':'peach',
  'banana':'banana','bananas':'banana',
  'avocado':'avocado','avocados':'avocado',
  'mango':'mango','mangoes':'mango',
  'orange':'orange','oranges':'orange',
  'grape':'grape','grapes':'grape','table grapes':'grape',
  'tomato':'tomato','tomatoes':'tomato',
  'cucumber':'cucumber','cucumbers':'cucumber',
  'pepper':'pepper','peppers':'pepper','sweet pepper':'pepper','capsicum':'pepper',
  'lettuce':'lettuce','lettuces':'lettuce',
  'cauliflower':'cauliflower','cauliflowers':'cauliflower',
  'broccoli':'broccoli','calabrese':'broccoli',
  'carrot':'carrot','carrots':'carrot',
  'mushroom':'champignon','mushrooms':'champignon','champignon':'champignon',
  // Norsk
  'eple':'apple','p√¶re':'pear','jordb√¶r':'strawberry','bringeb√¶r':'raspberry',
  'bl√•b√¶r':'blueberry','kirseb√¶r':'cherry','banan':'banana','avokado':'avocado',
  'mango':'mango','appelsin':'orange','druer':'grape','tomat':'tomato',
  'agurk':'cucumber','paprika':'pepper','salat':'lettuce','blomk√•l':'cauliflower',
  'brokkoli':'broccoli','gulrot':'carrot','champignon':'champignon',
};

function handleCsvDrop(e) {
  e.preventDefault();
  document.getElementById('csv-upload-area').style.borderColor='rgba(255,255,255,0.15)';
  const file = e.dataTransfer.files[0];
  if(file) handleCsvFile(file);
}

function handleCsvFile(file) {
  if(!file) return;
  showCsvStatus('loading', `<span class="spinner"></span>Leser ${file.name}...`);
  document.getElementById('csv-results').style.display='none';

  const reader = new FileReader();
  reader.onload = (e) => parseCsvData(e.target.result, file.name);
  reader.readAsText(file, 'UTF-8');
}

function parseCsvData(text, filename) {
  const lines = text.trim().split('\n').filter(l => l.trim());
  if(lines.length < 2) { showCsvStatus('error','‚ùå Filen er tom eller ugyldig'); return; }

  // Show raw preview
  const previewEl = document.getElementById('csv-raw-preview');
  if(previewEl) previewEl.textContent = lines.slice(0,6).join('\n');

  const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/['"]/g,''));

  // Detect format
  const isDefra = headers.includes('item') && headers.includes('price') && headers.includes('unit');
  const isEuAgri = headers.includes('product') && headers.includes('price_eur');
  const isCustom = headers.includes('product') && headers.includes('price');

  const pricesByProduct = {};

  lines.slice(1).forEach(line => {
    const vals = line.split(',').map(v => v.trim().replace(/^["']|["']$/g,''));
    const row = {};
    headers.forEach((h,i) => row[h] = vals[i]||'');

    let productRaw='', price=0, unit='EUR/100kg', date='';

    if(isDefra) {
      productRaw = (row.item||'').toLowerCase();
      const priceGbp = parseFloat(row.price);
      if(isNaN(priceGbp)||priceGbp<=0) return;
      // Convert GBP/kg ‚Üí EUR/100kg (use stored rate or 1.18 as fallback)
      const gbpEur = window._gbpEurRate || 1.18;
      price = Math.round(priceGbp * gbpEur * 100 * 100) / 100;
      date = row.date || row.week || '';
    } else if(isEuAgri) {
      productRaw = (row.product||'').toLowerCase();
      price = parseFloat(row.price_eur);
      date = row.week && row.year ? `Uke ${row.week} ${row.year}` : '';
    } else if(isCustom) {
      productRaw = (row.product||'').toLowerCase();
      price = parseFloat(row.price);
      const unitRaw = (row.unit||'eur/100kg').toLowerCase();
      if(unitRaw.includes('/kg') && !unitRaw.includes('100')) {
        price = price * 100; // convert ‚Ç¨/kg to ‚Ç¨/100kg internal
      }
      date = row.date || row.week || '';
    } else return;

    const key = CSV_NAME_MAP[productRaw];
    if(!key || isNaN(price) || price<=0) return;

    if(!pricesByProduct[key]) pricesByProduct[key] = {prices:[], dates:[]};
    pricesByProduct[key].prices.push(price);
    pricesByProduct[key].dates.push(date);
  });

  // Average by product
  extractedCsvPrices = {};
  Object.entries(pricesByProduct).forEach(([key, d]) => {
    const avg = d.prices.reduce((a,b)=>a+b,0)/d.prices.length;
    const latest = d.prices[d.prices.length-1];
    extractedCsvPrices[key] = {
      price: Math.round(avg*100)/100,
      latestDate: d.dates[d.dates.length-1]||'',
      count: d.prices.length,
      allPrices: d.prices,
      allDates: d.dates
    };
  });

  const count = Object.keys(extractedCsvPrices).length;
  if(count === 0) {
    showCsvStatus('warn', `‚ö†Ô∏è Ingen gjenkjente produkter. Sjekk kolonnenavn. Forventede kolonner: ${isDefra?'item, price, unit':isEuAgri?'product, price_eur':'product, price'}`);
    return;
  }

  renderCsvPreview(filename, count, isDefra?'UK DEFRA':isEuAgri?'EU Agridata':'Egendefinert');
  showCsvStatus('ok', `‚úÖ ${count} produkter funnet fra ${filename}`);
}

function renderCsvPreview(filename, count, format) {
  document.getElementById('csv-source-label').textContent =
    `${filename} ¬∑ ${format} format ¬∑ ${count} produkter`;

  const grid = document.getElementById('csv-price-grid');
  grid.innerHTML = '';

  Object.entries(extractedCsvPrices).forEach(([key, d]) => {
    const cfg = PRODUCT_CONFIG[key];
    if(!cfg) return;
    const displayPrice = (d.price/100).toFixed(2);
    grid.innerHTML += `<div class="panel-card" style="border-bottom:2px solid ${cfg.color}">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px">
        <span style="font-size:11px;color:var(--text3);font-family:'DM Mono',monospace">${cfg.name.toUpperCase()}</span>
        <span style="font-size:18px">${cfg.emoji}</span>
      </div>
      <div style="font-family:'DM Serif Display',serif;font-size:22px;color:${cfg.color};margin-bottom:4px">
        ‚Ç¨${displayPrice}<span style="font-size:11px;color:var(--text3)">/kg</span>
      </div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:4px">
        <span class="kpi-badge badge-live">CSV</span>
        ${d.count>1?`<span style="font-size:9px;color:var(--text3);font-family:'DM Mono',monospace">${d.count} rader</span>`:''}
        ${d.latestDate?`<span style="font-size:9px;color:var(--text3);font-family:'DM Mono',monospace">${d.latestDate}</span>`:''}
      </div>
    </div>`;
  });

  document.getElementById('csv-results').style.display='block';
}

function applyCsvPrices() {
  let count = 0;
  Object.entries(extractedCsvPrices).forEach(([key, d]) => {
    if(!liveData[key] || !d.price) return;
    const newPrices = d.allPrices.length > 1
      ? [...(liveData[key].prices||[]), ...d.allPrices]
      : [...(liveData[key].prices||[]), d.price];
    const newLabels = d.allDates.length > 0
      ? [...(liveData[key].labels||[]), ...d.allDates.map((dt,i)=>dt||`CSV import ${i+1}`)]
      : [...(liveData[key].labels||[]), 'CSV import'];
    const latest = d.allPrices[d.allPrices.length-1];
    const prev = liveData[key].latest || latest;
    const weekChange = prev ? Math.round(((latest-prev)/prev)*1000)/10 : 0;
    liveData[key] = { ...liveData[key], prices:newPrices, labels:newLabels, latest, weekChange, source:'csv' };
    count++;
  });

  if(count > 0) {
    renderSidebar();
    renderKpiGrid(currentFilter);
    buildMainChart(currentProduct, '6m');
    buildDetailPanels(currentProduct);
    buildCompareChart();
    switchTab('priser', document.querySelectorAll('.tab-btn')[0]);
    showBanner('ok', `‚úÖ ${count} produktpriser oppdatert fra CSV-import.`);
  }
}

function cancelCsvImport() {
  extractedCsvPrices = {};
  document.getElementById('csv-results').style.display='none';
  document.getElementById('csv-status').style.display='none';
  document.getElementById('csv-file-input').value='';
}

function showCsvStatus(type, msg) {
  const el = document.getElementById('csv-status');
  el.style.display = 'block';
  const styles = {
    loading: 'background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.3);color:#60a5fa',
    ok:      'background:rgba(74,222,128,.1);border:1px solid rgba(74,222,128,.3);color:#4ade80',
    warn:    'background:rgba(251,191,36,.1);border:1px solid rgba(251,191,36,.3);color:#fbbf24',
    error:   'background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.3);color:#f87171',
  };
  el.style.cssText += ';'+styles[type];
  el.innerHTML = msg;
}

window.addEventListener('load',()=>{
  loadAllData();
  loadDriverData();
});
</script>
</body>
</html>
